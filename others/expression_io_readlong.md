# InputStream readLong 优化

今天整理现在手头上的项目，发现一个问题，觉得还是很值得记录一下的。

有这么一个工具类，有一个方法是 readInt(InputStream)，每次只读取一个字节。其他 readXXX的方法，大多需要会调用这个方法。我通过 trace 文件分析的时候，发现这个方法被调用的次数太多了，往上一追，发现是一个 readLong 的方法，每次 readLong 会调用这个方法 8 次。这是符合逻辑的，确实应该调用 8 次。那么 readLong 为啥被调用那么多次呢。原来是在读取字符串，readString() ，可以看出，在项目里，走的是私有协议，按一定的顺序读取数据，每次读取字符串的时候，先 readLong，或者字符串的长度，然后再读取对应长度的 byte 数组，然后 new 一个 String。看上去没有任何问题。

但是在 readLong 里调用 8 次 readInt 确实有点说不过去。当然，这样的设计在当初可能是没什么问题，可能项目一开始的时候，对这个方法的调用的次数和频率都不是很多。但是由于后续历史问题，这些方法被无意中增加了太多的调用，因为他们都是封装好的，调用者都不关心的，所以慢慢的，在我这次偶然的 trace 分析中，发现了这个问题。

那么这个问题其实很好解决，readLong 就是要读取 8 个字节，那么，我改成 InputStream.read(byte[]) 的方式去读取，再次运行，trace 文件分析。个人觉得效果是非常理想的。后续我会贴代码。